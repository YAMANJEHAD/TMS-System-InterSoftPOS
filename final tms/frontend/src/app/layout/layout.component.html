<!-- Layout Component Loaded -->
<div class="layout-wrapper" [class.sidebar-open]="sidebarOpen">
  <!-- Mobile Overlay -->
  <div class="sidebar-overlay" *ngIf="sidebarOpen" (click)="closeSidebar()"></div>
  
  <!-- Sidebar -->
  <aside class="sidebar bg-dark text-white" [class.open]="sidebarOpen">
    <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
      <div>
        <div class="d-flex align-items-center mb-2">
          <h5 class="mb-0">INTERSOFT TMS</h5>
        </div>
        <small class="text-muted">International Software Company</small>
      </div>
      <!-- Mobile Close Button -->
      <button class="btn btn-link text-white d-lg-none p-0 ms-auto" (click)="closeSidebar()" type="button" style="font-size: 1.5rem;">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    
    <div class="p-3 border-bottom">
      <p class="mb-0 small">Welcome back, <strong>{{ userName }}</strong></p>
    </div>

    <nav class="p-2">
      <ul class="list-unstyled mb-0">
        <!-- Dashboard -->
        <li class="mb-1">
          <a routerLink="/dashboard" routerLinkActive="active" class="nav-link text-white d-flex align-items-center p-2 rounded" (click)="closeSidebar()">
            <i class="bi bi-speedometer2 me-2"></i>
            <span>Dashboard</span>
          </a>
        </li>

        <!-- Tasks Section -->
        <li class="mb-1">
          <a routerLink="/tasks" routerLinkActive="active" class="nav-link text-white d-flex align-items-center p-2 rounded" (click)="closeSidebar()">
            <i class="bi bi-list-task me-2"></i>
            <span>All Tasks</span>
          </a>
        </li>
        <li class="mb-1">
          <a routerLink="/my-tasks" routerLinkActive="active" class="nav-link text-white d-flex align-items-center p-2 rounded" (click)="closeSidebar()">
            <i class="bi bi-person-check me-2"></i>
            <span>My Tasks</span>
          </a>
        </li>

        <!-- Inventory Section with Submenu -->
        <li class="mb-1">
          <a class="nav-link text-white d-flex align-items-center justify-content-between p-2 rounded" 
             [class.submenu-parent-open]="inventoryOpen"
             (click)="toggleInventory()" 
             style="cursor: pointer;">
            <div class="d-flex align-items-center">
              <i class="bi bi-box-seam me-2"></i>
              <span>Inventory</span>
            </div>
            <i class="bi" [class.bi-chevron-down]="!inventoryOpen" [class.bi-chevron-up]="inventoryOpen"></i>
          </a>
          <ul class="list-unstyled ms-3 mt-2 submenu" [class.show]="inventoryOpen">
            <li class="mb-1">
              <a routerLink="/inventory/add" routerLinkActive="active" class="nav-link text-white d-flex align-items-center p-2 rounded submenu-link" (click)="closeSidebar()">
                <i class="bi bi-plus-circle me-2"></i>
                <span>Add Inventory</span>
              </a>
            </li>
            <li class="mb-1">
              <a routerLink="/inventory/reports" routerLinkActive="active" class="nav-link text-white d-flex align-items-center p-2 rounded submenu-link" (click)="closeSidebar()">
                <i class="bi bi-file-earmark-text me-2"></i>
                <span>Inventory Reports</span>
              </a>
            </li>
          </ul>
        </li>

        <!-- Transfers Section with Submenu -->
        <li class="mb-1">
          <a class="nav-link text-white d-flex align-items-center justify-content-between p-2 rounded" 
             [class.submenu-parent-open]="transfersOpen"
             (click)="toggleTransfers()" 
             style="cursor: pointer;">
            <div class="d-flex align-items-center">
              <i class="bi bi-arrow-left-right me-2"></i>
              <span>Ticket Transfer</span>
            </div>
            <i class="bi" [class.bi-chevron-down]="!transfersOpen" [class.bi-chevron-up]="transfersOpen"></i>
          </a>
          <ul class="list-unstyled ms-3 mt-2 submenu" [class.show]="transfersOpen">
            <li class="mb-1">
              <a routerLink="/transfer/add" routerLinkActive="active" class="nav-link text-white d-flex align-items-center p-2 rounded submenu-link" (click)="closeSidebar()">
                <i class="bi bi-plus-circle me-2"></i>
                <span>Add Transfer</span>
              </a>
            </li>
            <li class="mb-1">
              <a routerLink="/transfer/reports" routerLinkActive="active" class="nav-link text-white d-flex align-items-center p-2 rounded submenu-link" (click)="closeSidebar()">
                <i class="bi bi-file-earmark-text me-2"></i>
                <span>Transfer Reports</span>
              </a>
            </li>
          </ul>
        </li>

        <!-- Other Menu Items -->
        <li class="mb-1">
          <a routerLink="/papers" routerLinkActive="active" class="nav-link text-white d-flex align-items-center p-2 rounded" (click)="closeSidebar()">
            <i class="bi bi-file-earmark-x me-2"></i>
            <span>Paper Cancelled</span>
          </a>
        </li>
        <li class="mb-1">
          <a routerLink="/job-orders" routerLinkActive="active" class="nav-link text-white d-flex align-items-center p-2 rounded" (click)="closeSidebar()">
            <i class="bi bi-briefcase me-2"></i>
            <span>Job Orders</span>
          </a>
        </li>
        <li class="mb-1">
          <a routerLink="/reports" routerLinkActive="active" class="nav-link text-white d-flex align-items-center p-2 rounded" (click)="closeSidebar()">
            <i class="bi bi-graph-up me-2"></i>
            <span>Reports</span>
          </a>
        </li>
        <li class="mb-1">
          <a routerLink="/users" routerLinkActive="active" class="nav-link text-white d-flex align-items-center p-2 rounded" (click)="closeSidebar()">
            <i class="bi bi-people me-2"></i>
            <span>User Management</span>
            <span *ngIf="!isAdmin()" class="badge bg-warning ms-2" title="Admin Only">Admin</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <div class="main-content-wrapper">
    <!-- Header -->
    <header class="bg-white border-bottom">
      <div class="header-content">
        <div class="d-flex align-items-center gap-2 gap-md-3">
          <!-- Mobile Menu Toggle -->
          <button class="btn btn-outline-secondary btn-sm d-lg-none" (click)="toggleSidebar()" type="button">
            <i class="bi bi-list"></i>
          </button>
          
          <!-- Add Task Button -->
          <button class="btn btn-primary btn-sm" (click)="openAddTaskModal()">
            <i class="bi bi-plus-circle me-1"></i> 
            <span class="d-none d-md-inline">Add Task</span>
          </button>
        </div>
        
        <div class="d-flex align-items-center gap-2 gap-md-3">
          <!-- Google Sheet Button -->
          <button class="btn btn-outline-secondary btn-sm d-none d-md-inline-flex" (click)="openGoogleSheet()" title="Google Sheet">
            <i class="bi bi-google"></i>
          </button>
          
          <!-- Analyzer Button -->
          <button class="btn btn-outline-secondary btn-sm d-none d-md-inline-flex" (click)="openAnalyzer()" title="Analyzer">
            <i class="bi bi-graph-up"></i>
          </button>
          
          <!-- Notifications -->
          <div class="position-relative">
            <button class="btn btn-outline-secondary btn-sm position-relative" (click)="showNotifications = !showNotifications">
              <i class="bi bi-bell"></i>
              <span *ngIf="unreadCount > 0" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                {{ unreadCount }}
              </span>
            </button>
            <div *ngIf="showNotifications" class="notifications-dropdown">
              <div class="p-2 border-bottom">
                <strong>Notifications</strong>
              </div>
              <div *ngIf="notifications.length === 0" class="p-3 text-muted text-center">
                No notifications
              </div>
              <div *ngFor="let notif of notifications" class="p-2 border-bottom notification-item d-flex justify-content-between align-items-start" [class.bg-light]="!notif.isRead">
                <div class="flex-grow-1" (click)="markAsRead(notif.notificationId)" style="cursor: pointer;">
                  <div class="small">{{ notif.message }}</div>
                  <div class="text-muted" style="font-size: 0.75rem;">{{ notif.createdAt | date:'short' }}</div>
                </div>
                <button class="btn btn-sm btn-link text-danger p-0 ms-2" (click)="deleteNotification(notif.notificationId); $event.stopPropagation()" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Date & Time -->
          <div class="text-muted small d-none d-lg-block">
            {{ currentTime | date:'medium' }}
          </div>
          <div class="text-muted small d-lg-none">
            {{ currentTime | date:'short' }}
          </div>
          
          <!-- User Profile -->
          <div class="position-relative">
            <button class="btn btn-outline-secondary btn-sm d-flex align-items-center" (click)="showUserMenu = !showUserMenu">
              <i class="bi bi-person-circle me-1"></i>
              <span class="d-none d-md-inline">{{ userName }}</span>
            </button>
            <div *ngIf="showUserMenu" class="user-menu-dropdown">
              <div class="p-2 border-bottom">
                <div class="fw-bold">{{ userName }}</div>
                <div class="small text-muted">{{ authService.getUserName() }}</div>
              </div>
              <a class="d-block p-2 text-decoration-none text-dark" href="#" (click)="openSelfUpdateModal(); showUserMenu = false; $event.preventDefault()">
                <i class="bi bi-gear me-2"></i> Settings
              </a>
              <a class="d-block p-2 text-decoration-none text-dark border-top" href="#" (click)="logout(); $event.preventDefault()">
                <i class="bi bi-box-arrow-right me-2"></i> Logout
              </a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Page Content -->
    <main class="main-content">
      <router-outlet></router-outlet>
    </main>

    <!-- Global Footer -->
    <footer class="bg-light border-top py-3 mt-auto">
      <div class="container-fluid px-4">
        <div class="text-center text-muted small">
          <p class="mb-0">Â© 2025 INTERSOFT TMS. All rights reserved.</p>
        </div>
      </div>
    </footer>
  </div>
</div>

<!-- Self-Update Modal -->
<div class="modal fade" [class.show]="showSelfUpdateModal" [style.display]="showSelfUpdateModal ? 'block' : 'none'" tabindex="-1" *ngIf="showSelfUpdateModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-person-circle me-2"></i>Update Profile
        </h5>
        <button type="button" class="btn-close" (click)="closeSelfUpdateModal()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" [(ngModel)]="selfUpdateForm.name" name="selfName">
          </div>
          <div class="mb-3">
            <label class="form-label">Phone</label>
            <input type="number" class="form-control" [(ngModel)]="selfUpdateForm.phone" name="selfPhone">
          </div>
          <div class="mb-3">
            <label class="form-label">Avatar Color</label>
            <input type="color" class="form-control form-control-color" [(ngModel)]="selfUpdateForm.avatar_color" name="selfAvatarColor" title="Choose avatar color">
          </div>
          <div class="mb-3">
            <label class="form-label">Theme</label>
            <select class="form-select" [(ngModel)]="selfUpdateForm.theme" name="selfTheme">
              <option value="">Default</option>
              <option value="light">Light</option>
              <option value="dark">Dark</option>
              <option value="auto">Auto</option>
            </select>
          </div>
          <div *ngIf="selfUpdateError" class="alert alert-danger">{{ selfUpdateError }}</div>
          <div *ngIf="selfUpdateSuccessMessage" class="alert alert-success">{{ selfUpdateSuccessMessage }}</div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeSelfUpdateModal()" [disabled]="updatingSelf">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" (click)="updateSelf()" [disabled]="updatingSelf">
          <span *ngIf="updatingSelf" class="spinner-border spinner-border-sm me-2"></span>
          <i *ngIf="!updatingSelf" class="bi bi-check-circle me-2"></i>
          {{ updatingSelf ? 'Updating...' : 'Update Profile' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="showSelfUpdateModal" (click)="closeSelfUpdateModal()"></div>

<!-- Add Task Modal -->
<div class="modal fade" [class.show]="showAddTaskModal" [style.display]="showAddTaskModal ? 'block' : 'none'" tabindex="-1" *ngIf="showAddTaskModal">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Task</h5>
        <button type="button" class="btn-close" (click)="closeAddTaskModal()"></button>
      </div>
      <div class="modal-body">
        <!-- Success Message -->
        <div *ngIf="taskSuccessMessage" class="alert alert-success alert-dismissible fade show" role="alert">
          {{ taskSuccessMessage }}
          <button type="button" class="btn-close" (click)="taskSuccessMessage = null"></button>
        </div>

        <!-- Error Message -->
        <div *ngIf="taskError" class="alert alert-danger alert-dismissible fade show" role="alert">
          {{ taskError }}
          <button type="button" class="btn-close" (click)="taskError = null"></button>
        </div>

        <form (ngSubmit)="createTask()">
          <div class="mb-3">
            <label class="form-label">Title <span class="text-danger">*</span></label>
            <input type="text" class="form-control" [(ngModel)]="taskForm.title" name="taskTitle" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" [(ngModel)]="taskForm.description" name="taskDescription" rows="4"></textarea>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Due Date <span class="text-danger">*</span></label>
              <input type="datetime-local" class="form-control" [(ngModel)]="taskForm.dueDate" name="taskDueDate" required>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Status <span class="text-danger">*</span></label>
              <select class="form-select" [(ngModel)]="taskForm.statusId" name="taskStatusId" required [disabled]="loadingTaskFilters">
                <option [value]="0">Select Status</option>
                <option *ngFor="let status of statuses" [value]="status.statusId">
                  {{ status.statusName }}
                </option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Priority <span class="text-danger">*</span></label>
              <select class="form-select" [(ngModel)]="taskForm.priorityId" name="taskPriorityId" required [disabled]="loadingTaskFilters">
                <option [value]="0">Select Priority</option>
                <option *ngFor="let priority of priorities" [value]="priority.priorityId">
                  {{ priority.priorityName }}
                </option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Project <span class="text-danger">*</span></label>
            <select class="form-select" [(ngModel)]="taskForm.projectId" name="taskProjectId" required [disabled]="loadingTaskFilters">
              <option [value]="0">Select Project</option>
              <option *ngFor="let project of projects" [value]="project.projectId">
                {{ project.name }}
              </option>
            </select>
          </div>

          <!-- Assign to Users (Multi-select) -->
          <div class="mb-3">
            <label class="form-label">Assign to Users</label>
            <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto; background-color: #f8f9fa;">
              <div *ngIf="loadingTaskFilters" class="text-center text-muted">
                <small>Loading users...</small>
              </div>
              <ng-container *ngIf="!loadingTaskFilters">
                <div *ngFor="let user of users" class="form-check">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [id]="'user-' + user.userId"
                    [checked]="isUserSelected(user.userId)"
                    (change)="toggleUserSelection(user.userId)">
                  <label class="form-check-label" [for]="'user-' + user.userId">
                    {{ user.name }}
                  </label>
                </div>
                <div *ngIf="users.length === 0" class="text-muted small">
                  No users available
                </div>
              </ng-container>
            </div>
            <small class="form-text text-muted">
              Selected users: {{ selectedUserIds.length }}
            </small>
          </div>

          <!-- File Upload -->
          <div class="mb-3">
            <label class="form-label">Attachment</label>
            <div 
              class="file-upload-area border rounded p-4 text-center"
              [class.dragging]="isDragging"
              [class.has-file]="selectedFile"
              (dragover)="onDragOver($event)"
              (dragleave)="onDragLeave($event)"
              (drop)="onDrop($event)"
              style="cursor: pointer; transition: all 0.3s ease;"
              [style.background-color]="isDragging ? '#e7f3ff' : (selectedFile ? '#d4edda' : '#f8f9fa')"
              [style.border-color]="isDragging ? '#0d6efd' : '#dee2e6'">
              <input 
                type="file" 
                id="taskFileInput" 
                class="d-none" 
                (change)="onFileSelected($event)"
                #fileInput>
              
              <div *ngIf="!selectedFile">
                <i class="bi bi-cloud-upload fs-1 text-muted mb-2"></i>
                <p class="mb-1">
                  <strong>Click to upload</strong> or drag and drop
                </p>
                <p class="small text-muted mb-0">
                  Select a file to attach to this task
                </p>
              </div>
              
              <div *ngIf="selectedFile" class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                  <i class="bi bi-file-earmark-text fs-4 text-primary me-2"></i>
                  <div>
                    <div class="fw-bold">{{ selectedFile.name }}</div>
                    <small class="text-muted">{{ (selectedFile.size / 1024).toFixed(2) }} KB</small>
                  </div>
                </div>
                <button 
                  type="button" 
                  class="btn btn-sm btn-outline-danger"
                  (click)="removeFile(); fileInput.value = ''">
                  <i class="bi bi-x-circle"></i> Remove
                </button>
              </div>
            </div>
            <button 
              type="button" 
              class="btn btn-sm btn-outline-secondary mt-2"
              (click)="fileInput.click()"
              *ngIf="!selectedFile">
              <i class="bi bi-folder2-open me-1"></i> Browse Files
            </button>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeAddTaskModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="createTask()" [disabled]="creatingTask || loadingTaskFilters">
          <span *ngIf="creatingTask" class="spinner-border spinner-border-sm me-2"></span>
          {{ creatingTask ? 'Creating...' : 'Create Task' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="showAddTaskModal" (click)="closeAddTaskModal()"></div>
