<div class="transfer-container">
  <div class="page-header">
    <h1>Transfer</h1>
    <div class="header-actions">
      <button class="primary-button" (click)="openAddModal()">Add Transfer</button>
      <button class="accent-button" (click)="openBatchModal()">Add Batch Transfer</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-card card">
    <h2>Filters</h2>
    <div class="filters-grid">
      <div class="form-group">
        <label>
          <span class="material-icons">event</span>
          From Date
        </label>
        <input type="date" [(ngModel)]="fromDate" />
      </div>
      <div class="form-group">
        <label>
          <span class="material-icons">event</span>
          To Date
        </label>
        <input type="date" [(ngModel)]="toDate" />
      </div>
      <div class="form-group">
        <label>Ticket No</label>
        <input type="text" [(ngModel)]="ticketNo" placeholder="Search by ticket number" />
      </div>
      <div class="form-group">
        <label>Terminal Number</label>
        <input type="text" [(ngModel)]="terminalNumber" placeholder="Search by terminal number" />
      </div>
      <div class="form-group">
        <label>Duplicate Count</label>
        <input type="text" [(ngModel)]="duplicateCount" placeholder="Search by duplicate count" />
      </div>
    </div>
    <div class="filter-actions">
      <button class="primary-button" (click)="applyFilters()">Apply Filters</button>
    </div>
  </div>

  <!-- Transfers Table -->
  <div class="table-container card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
      <h2>Transfers</h2>
      <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
        <button class="excel-export-button" (click)="exportToExcel()">
          <span class="material-icons">table_chart</span>
          <span>Export Excel</span>
        </button>
        <label>Items per page:</label>
        <select [(ngModel)]="pageSize" (change)="onPageSizeChange()" style="padding: 5px 10px; border-radius: 4px;">
          <option [value]="10">10</option>
          <option [value]="25">25</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>
      </div>
    </div>
    <div class="loading" *ngIf="isLoading">Loading transfers...</div>
    
    <table *ngIf="!isLoading">
      <thead>
        <tr>
          <th>Terminal Number</th>
          <th>Ticket No</th>
          <th>Transfer Details</th>
          <th>Status</th>
          <th>Created At</th>
          <th>User Name</th>
          <th>Duplicate Count</th>
          <th class="action-column">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let transfer of filteredTransfers" [class.duplicate-row]="transfer.duplicateCount >= 3">
          <td>{{ transfer.terminalNumber }}</td>
          <td>{{ transfer.ticketNo }}</td>
          <td>
            <div class="transfer-details">
              <span class="from-tech">{{ transfer.fromTech }}</span>
              <span class="arrow">→</span>
              <span class="to-tech">{{ transfer.toTech }}</span>
            </div>
          </td>
          <td>
            <span [class]="'status-badge status-' + getStatusClass(transfer.statusName)">
              {{ transfer.statusName }}
            </span>
          </td>
          <td>{{ transfer.createdAt | date:'shortDate' }}</td>
          <td>
            <div class="user-cell">
              <div class="user-avatar" [style.background-color]="getUserAvatarColor(transfer.userName)">
                {{ getUserInitials(transfer.userName) }}
              </div>
              <span class="user-name">{{ transfer.userName }}</span>
            </div>
          </td>
          <td>{{ transfer.duplicateCount }}</td>
          <td class="action-column">
            <div class="action-buttons">
              <button class="btn-approve" (click)="approveTransfer(transfer.id)" title="Approve">
                <span class="material-icons">check_circle</span>
              </button>
              <button class="btn-reject" (click)="openRejectModal(transfer.id)" title="Reject">
                <span class="material-icons">cancel</span>
              </button>
              <button class="btn-delete" (click)="openDeleteModal(transfer.id)" title="Delete">
                <span class="material-icons">delete</span>
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="filteredTransfers.length === 0">
          <td colspan="8" class="no-data">No transfers found</td>
        </tr>
      </tbody>
    </table>
    
    <!-- Pagination -->
    <div class="pagination" *ngIf="transfers.length > 0">
      <button class="btn-pagination" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1">Previous</button>
      <span>Page {{ currentPage }}<span *ngIf="totalPages > currentPage"> of {{ totalPages }}</span></span>
      <button class="btn-pagination" (click)="onPageChange(currentPage + 1)" [disabled]="transfers.length < pageSize">Next</button>
      <span class="pagination-info" *ngIf="totalItems > 0">(Showing {{ (currentPage - 1) * pageSize + 1 }}-{{ (currentPage - 1) * pageSize + transfers.length }} of ~{{ totalItems }}+)</span>
    </div>
  </div>

  <!-- Add Transfer Modal -->
  <div class="modal" *ngIf="showAddModal" (click)="closeAddModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Add Transfer</h2>
        <button class="close-btn" (click)="closeAddModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Terminal Number *</label>
          <input type="text" [(ngModel)]="formData.terminalNumber" />
        </div>
        <div class="form-group">
          <label>Ticket No *</label>
          <input type="text" [(ngModel)]="formData.ticketNo" />
        </div>
        <div class="form-group">
          <label>From Tech *</label>
          <select [(ngModel)]="formData.fromTechId">
            <option [value]="0">Select Technician</option>
            <option *ngFor="let tech of technicians" [value]="tech.techId">
              {{ tech.techName }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>To Tech *</label>
          <select [(ngModel)]="formData.toTechId">
            <option [value]="0">Select Technician</option>
            <option *ngFor="let tech of technicians" [value]="tech.techId">
              {{ tech.techName }}
            </option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary-button" (click)="closeAddModal()">Cancel</button>
        <button class="secondary-button" (click)="duplicateCurrentTransfer()" title="Duplicate this transfer">
          <span class="material-icons" style="font-size: 18px; vertical-align: middle;">content_copy</span>
          Duplicate
        </button>
        <button class="primary-button" (click)="createTransfer()">Create</button>
      </div>
    </div>
  </div>

  <!-- Batch Transfer Modal -->
  <div class="modal" *ngIf="showBatchModal" (click)="closeBatchModal()">
    <div class="modal-content large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Add Batch Transfer</h2>
        <button class="close-btn" (click)="closeBatchModal()">×</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="batchTransferForm" class="batch-transfer-form">
          <!-- Technician Dropdowns at Top -->
          <div class="batch-dropdowns">
          <div class="form-group">
              <label>
                <span class="material-icons">person</span>
                From Technician *
              </label>
              <select 
                formControlName="fromTechId"
                class="batch-select">
                <option [value]="0">Select Technician</option>
                      <option *ngFor="let tech of technicians" [value]="tech.techId">
                        {{ tech.techName }}
                      </option>
                    </select>
              <small class="error-message" *ngIf="batchTransferForm.get('fromTechId')?.invalid && batchTransferForm.get('fromTechId')?.touched">
                From Technician is required
              </small>
            </div>
            <div class="form-group">
              <label>
                <span class="material-icons">person</span>
                To Technician *
              </label>
              <select 
                formControlName="toTechId"
                class="batch-select">
                <option [value]="0">Select Technician</option>
                      <option *ngFor="let tech of technicians" [value]="tech.techId">
                        {{ tech.techName }}
                      </option>
                    </select>
              <small class="error-message" *ngIf="batchTransferForm.get('toTechId')?.invalid && batchTransferForm.get('toTechId')?.touched">
                To Technician is required
              </small>
            </div>
          </div>

          <!-- Textareas for Bulk Input -->
          <div class="batch-textareas">
            <div class="form-group">
              <label>
                <span class="material-icons">confirmation_number</span>
                Terminal Numbers * (one per line)
              </label>
              <textarea 
                formControlName="terminalNumbers"
                class="batch-textarea"
                placeholder="Enter terminal numbers, one per line&#10;Example:&#10;12345&#10;67890&#10;11111"
                rows="6"></textarea>
              <small class="error-message" *ngIf="batchTransferForm.get('terminalNumbers')?.invalid && batchTransferForm.get('terminalNumbers')?.touched">
                Terminal Numbers are required
              </small>
              <small class="field-hint">
                Enter one terminal number per line. Each line will be matched with the corresponding ticket number.
              </small>
            </div>
            <div class="form-group">
              <label>
                <span class="material-icons">receipt</span>
                Ticket Numbers * (one per line)
              </label>
              <textarea 
                formControlName="ticketNumbers"
                class="batch-textarea"
                placeholder="Enter ticket numbers, one per line&#10;Example:&#10;T001&#10;T002&#10;T003"
                rows="6"></textarea>
              <small class="error-message" *ngIf="batchTransferForm.get('ticketNumbers')?.invalid && batchTransferForm.get('ticketNumbers')?.touched">
                Ticket Numbers are required
              </small>
              <small class="field-hint">
                Enter one ticket number per line. Must match the number of terminal numbers.
              </small>
            </div>
          </div>

          <!-- Preview Section -->
          <div class="batch-preview" *ngIf="batchTransfers.length > 0">
            <h4>
              <span class="material-icons">preview</span>
              Preview ({{ batchTransfers.length }} transfer(s))
            </h4>
            <div class="preview-list">
              <div 
                *ngFor="let transfer of batchTransfers; let i = index" 
                class="preview-item"
                [class.invalid-item]="!transfer.terminalNumber || !transfer.ticketNo">
                <span class="item-number">{{ i + 1 }}.</span>
                <span class="item-details">
                  Terminal: <strong>{{ transfer.terminalNumber || '(empty)' }}</strong> | 
                  Ticket: <strong>{{ transfer.ticketNo || '(empty)' }}</strong>
                </span>
              </div>
                    </div>
          </div>

          <!-- Hint -->
          <div class="batch-hint">
            <span class="material-icons">info</span>
            <span>Enter terminal numbers and ticket numbers line by line. Each line will be matched (line 1 with line 1, etc.). Select technicians from the dropdowns above.</span>
        </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="secondary-button" (click)="closeBatchModal()">Cancel</button>
        <button 
          class="primary-button" 
          (click)="createBatchTransfers()"
          [disabled]="batchTransferForm.invalid">
          <span class="material-icons">save</span>
          <span>Create Batch Transfers</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Reject Modal -->
  <div class="modal" *ngIf="showRejectModal" (click)="closeRejectModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Reject Transfer</h2>
        <button class="close-btn" (click)="closeRejectModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Reject Reason *</label>
          <textarea [(ngModel)]="rejectReason" rows="4" placeholder="Enter reject reason" required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary-button" (click)="closeRejectModal()">Cancel</button>
        <button class="btn-reject" (click)="rejectTransfer()">Reject</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <app-confirmation-modal
    [show]="showDeleteModal"
    title="Delete Transfer"
    message="Are you sure you want to delete this transfer? This action cannot be undone."
    confirmText="Delete"
    cancelText="Cancel"
    type="danger"
    (confirmed)="deleteTransfer()"
    (closed)="closeDeleteModal()"
    (cancelled)="closeDeleteModal()">
  </app-confirmation-modal>
</div>
