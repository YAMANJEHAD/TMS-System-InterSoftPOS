<div class="container-fluid">
  <h2 class="mb-4">Reports</h2>

  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ error }}
    <button type="button" class="btn-close" (click)="error = null"></button>
  </div>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">Date Range Filter</h5>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Start Date</label>
          <input type="date" class="form-control" [(ngModel)]="filters.startDate" name="startDate">
        </div>
        <div class="col-md-4">
          <label class="form-label">End Date</label>
          <input type="date" class="form-control" [(ngModel)]="filters.endDate" name="endDate">
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <div class="w-100">
            <button class="btn btn-primary me-2 w-100" (click)="applyFilters()">
              <i class="bi bi-funnel me-2"></i>Apply Filters
            </button>
          </div>
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-outline-secondary" (click)="clearFilters()">
          <i class="bi bi-x-circle me-2"></i>Clear Filters
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Reports Content -->
  <div *ngIf="!loading && !error && reportData">
    <!-- Summary Cards -->
    <div class="row mb-4">
      <div class="col-md-3 mb-3">
        <div class="card text-center h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Total Projects</h6>
            <h3 class="card-title">{{ projects.length }}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Total Tasks</h6>
            <h3 class="card-title">{{ getTotalTasks() }}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Total Inventory</h6>
            <h3 class="card-title">{{ getTotalInventoryCount() }}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Total Transfers</h6>
            <h3 class="card-title">{{ getTotalTransferCount() }}</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Projects Report -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-folder me-2"></i>Projects Report</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Project Name</th>
                <th>Total Tasks</th>
                <th>Completed</th>
                <th>On Hold</th>
                <th>Under Process</th>
                <th>Completion Rate</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let project of projects">
                <td><strong>{{ project.projectName }}</strong></td>
                <td>{{ project.totalTasks }}</td>
                <td>
                  <span class="badge bg-success">{{ project.completedTasks }}</span>
                </td>
                <td>
                  <span class="badge bg-warning">{{ project.onHoldTasks }}</span>
                </td>
                <td>
                  <span class="badge bg-info">{{ project.underProcessTasks }}</span>
                </td>
                <td>
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-success" 
                         [style.width.%]="project.totalTasks > 0 ? (project.completedTasks / project.totalTasks * 100) : 0"
                         role="progressbar">
                      {{ project.totalTasks > 0 ? ((project.completedTasks / project.totalTasks * 100) | number:'1.0-0') : 0 }}%
                    </div>
                  </div>
                </td>
              </tr>
              <tr *ngIf="projects.length === 0">
                <td colspan="6" class="text-center text-muted">No project data available</td>
              </tr>
            </tbody>
            <tfoot *ngIf="projects.length > 0">
              <tr class="table-info">
                <td><strong>Total</strong></td>
                <td><strong>{{ getTotalTasks() }}</strong></td>
                <td><strong><span class="badge bg-success">{{ getTotalCompletedTasks() }}</span></strong></td>
                <td><strong><span class="badge bg-warning">{{ getTotalOnHoldTasks() }}</span></strong></td>
                <td><strong><span class="badge bg-info">{{ getTotalUnderProcessTasks() }}</span></strong></td>
                <td>
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-success" 
                         [style.width.%]="getTotalTasks() > 0 ? (getTotalCompletedTasks() / getTotalTasks() * 100) : 0"
                         role="progressbar">
                      {{ getTotalTasks() > 0 ? ((getTotalCompletedTasks() / getTotalTasks() * 100) | number:'1.0-0') : 0 }}%
                    </div>
                  </div>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Users Report -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Users Report</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>User ID</th>
                <th>User Name</th>
                <th>Inventory Count</th>
                <th>Transfer Count</th>
                <th>Total Activity</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let user of users">
                <td>{{ user.userId }}</td>
                <td>{{ getUserName(user.userId) }}</td>
                <td>
                  <span class="badge bg-primary">{{ user.inventoryCount }}</span>
                </td>
                <td>
                  <span class="badge bg-secondary">{{ user.transferCount }}</span>
                </td>
                <td>
                  <strong>{{ user.inventoryCount + user.transferCount }}</strong>
                </td>
              </tr>
              <tr *ngIf="users.length === 0">
                <td colspan="5" class="text-center text-muted">No user data available</td>
              </tr>
            </tbody>
            <tfoot *ngIf="users.length > 0">
              <tr class="table-info">
                <td colspan="2"><strong>Total</strong></td>
                <td><strong><span class="badge bg-primary">{{ getTotalInventoryCount() }}</span></strong></td>
                <td><strong><span class="badge bg-secondary">{{ getTotalTransferCount() }}</span></strong></td>
                <td><strong>{{ getTotalInventoryCount() + getTotalTransferCount() }}</strong></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
