<div class="users-management-container">
  <app-breadcrumb [items]="[{ label: 'Users Management' }]"></app-breadcrumb>
  
  <div class="page-header">
    <h1>Users Management</h1>
    <button 
      class="primary-button" 
      (click)="openAddModal()"
      *ngIf="sessionService.hasPermission('InsertUser')">
      <span class="material-icons">person_add</span>
      <span>Add User</span>
    </button>
  </div>

  <!-- Users Table -->
  <div class="table-container card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
      <h2>Users</h2>
      <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
        <button class="excel-export-button" (click)="exportToExcel()">
          <span class="material-icons">table_chart</span>
          <span>Export Excel</span>
        </button>
        <label>Items per page:</label>
        <select [(ngModel)]="pageSize" (change)="onPageSizeChange()" style="padding: 5px 10px; border-radius: 4px;">
          <option [value]="10">10</option>
          <option [value]="25">25</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>
      </div>
    </div>
    <div class="loading" *ngIf="isLoading">Loading users...</div>
    
    <table *ngIf="!isLoading">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Department</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users">
          <td>{{ user.userId }}</td>
          <td>
            <div class="user-cell">
              <div class="user-avatar" [style.background-color]="getUserAvatarColor(user)">
                {{ getUserInitials(user) }}
              </div>
              <span class="user-name">{{ user.name }}</span>
            </div>
          </td>
          <td>{{ user.email }}</td>
          <td>{{ user.roleName }}</td>
          <td>{{ user.departmentName || '-' }}</td>
          <td>
            <span [class]="user.isActive ? 'status-active' : 'status-inactive'">
              {{ user.isActive ? 'Active' : 'Inactive' }}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button 
                class="action-btn" 
                (click)="openEditModal(user)"
                title="Update"
                *ngIf="sessionService.hasPermission('UpdateUser')">
                <span class="material-icons">edit</span>
              </button>
              <button 
                class="action-btn" 
                (click)="openPermissionModal(user)"
                title="Permissions"
                *ngIf="sessionService.hasPermission('AssignPermissionToUser')">
                <span class="material-icons">security</span>
              </button>
              <button 
                [class]="user.isActive ? 'btn-deactivate' : 'btn-activate'"
                (click)="toggleUserActive(user)"
                [title]="user.isActive ? 'Deactivate' : 'Activate'"
                *ngIf="sessionService.hasPermission('SetUserIsActive')">
                <span class="material-icons">{{ user.isActive ? 'block' : 'check_circle' }}</span>
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="users.length === 0">
          <td colspan="7" class="no-data">No users found</td>
        </tr>
      </tbody>
    </table>
    
    <!-- Pagination -->
    <div class="pagination" *ngIf="users.length > 0">
      <button class="btn-pagination" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1">Previous</button>
      <span>Page {{ currentPage }}<span *ngIf="totalPages > currentPage"> of {{ totalPages }}</span></span>
      <button class="btn-pagination" (click)="onPageChange(currentPage + 1)" [disabled]="users.length < pageSize">Next</button>
      <span class="pagination-info" *ngIf="totalItems > 0">(Showing {{ (currentPage - 1) * pageSize + 1 }}-{{ (currentPage - 1) * pageSize + users.length }} of ~{{ totalItems }}+)</span>
    </div>
  </div>

  <!-- Add User Modal -->
  <div class="modal" *ngIf="showAddModal" (click)="closeAddModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Add User</h2>
        <button class="close-btn" (click)="closeAddModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" [(ngModel)]="formData.name" />
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" [(ngModel)]="formData.email" />
        </div>
        <div class="form-group">
          <label>Password *</label>
          <input type="password" [(ngModel)]="formData.passwordHash" />
        </div>
        <div class="form-group">
          <label>Role *</label>
          <select [(ngModel)]="formData.roleId" required>
            <option [value]="0">Select Role</option>
            <option *ngFor="let role of roles" [value]="role.roleId">
              {{ role.roleName }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>Department</label>
          <select [(ngModel)]="formData.departmentId">
            <option [value]="0">Select Department</option>
            <option *ngFor="let dept of departments" [value]="dept.departmentId">
              {{ dept.departmentName }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="number" [(ngModel)]="formData.phone" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary-button" (click)="closeAddModal()">Cancel</button>
        <button class="primary-button" (click)="createUser()">Create</button>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Update User</h2>
        <button class="close-btn" (click)="closeEditModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" [(ngModel)]="editFormData.name" />
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" [(ngModel)]="editFormData.email" />
        </div>
        <div class="form-group">
          <label>Password (leave empty to keep current)</label>
          <input type="password" [(ngModel)]="editFormData.passwordHash" />
        </div>
        <div class="form-group">
          <label>Role *</label>
          <select [(ngModel)]="editFormData.roleId" required>
            <option [value]="0">Select Role</option>
            <option *ngFor="let role of roles" [value]="role.roleId">
              {{ role.roleName }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>Department</label>
          <select [(ngModel)]="editFormData.departmentId">
            <option [value]="0">Select Department</option>
            <option *ngFor="let dept of departments" [value]="dept.departmentId">
              {{ dept.departmentName }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="number" [(ngModel)]="editFormData.phone" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary-button" (click)="closeEditModal()">Cancel</button>
        <button class="primary-button" (click)="updateUser()">Update</button>
      </div>
    </div>
  </div>

  <!-- Permission Modal -->
  <div class="modal" *ngIf="showPermissionModal" (click)="closePermissionModal()">
    <div class="modal-content permission-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Manage Permissions - {{ selectedUser?.name }}</h2>
        <button class="close-btn" (click)="closePermissionModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="permissions-list">
          <div class="permission-item" *ngFor="let perm of (userPermissions.length > 0 ? userPermissions : permissions)">
            <label class="permission-checkbox">
              <input 
                type="checkbox" 
                [checked]="isPermissionChecked(perm.permissionsId)"
                (change)="togglePermission(perm)" />
              <span class="permission-name">{{ perm.permissionsName }}</span>
            </label>
          </div>
          <div *ngIf="(userPermissions.length > 0 ? userPermissions : permissions).length === 0" class="no-permissions">
            No permissions available
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary-button" (click)="closePermissionModal()">Close</button>
      </div>
    </div>
  </div>
</div>
